<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Повольник — генератор персонажей</title>

<link href="https://fonts.googleapis.com/css2?family=Oranienbaum&family=El+Messiri:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --ink:#2b1f14; --soft:#5a4636; --gold:#b28b45; --gold2:#816331;
    --paper:#f6efdf; --paper2:#e6dcc6; --rose:#7c2f2f; --muted:#7c6a59;
    --danger:#aa3b3b;
  }
  html,body{height:100%;background:linear-gradient(180deg,var(--paper),var(--paper2));color:var(--ink)}
  body{margin:0;font-family:"El Messiri",system-ui,Segoe UI,Roboto,sans-serif}

  .sheet{
    max-width:960px;margin:24px auto;padding:28px;background:#fffdf8; /* плотный фон для печати */
    border-radius:12px;position:relative;
    border:12px solid transparent;
    border-image:url('data:image/svg+xml;utf8,\
      <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" viewBox="0 0 72 72">\
        <defs><pattern id="p" width="36" height="36" patternUnits="userSpaceOnUse">\
          <path d="M18 0v36M0 18h36" stroke="%23816331" stroke-width="1" opacity=".35"/>\
          <path d="M18 2c5 6 5 26 0 32C12 28 12 8 18 2Z" fill="%23b28b45" opacity=".15"/>\
        </pattern></defs>\
        <rect width="72" height="72" fill="url(%23p)"/>\
        <rect x="3" y="3" width="66" height="66" fill="none" stroke="%23816331" stroke-width="2"/>\
      </svg>') 12;
    box-shadow:0 20px 60px rgba(0,0,0,.12) inset, 0 8px 30px rgba(0,0,0,.12);
  }
  /* фиксированный декоративный слой */
  .sheet:before,.sheet:after{
    content:""; position:absolute; inset:0; pointer-events:none;
    background:
      radial-gradient(18px 18px at 10px 10px, var(--gold), transparent 70%),
      radial-gradient(18px 18px at calc(100% - 10px) 10px, var(--gold), transparent 70%),
      radial-gradient(18px 18px at 10px calc(100% - 10px), var(--gold), transparent 70%),
      radial-gradient(18px 18px at calc(100% - 10px) calc(100% - 10px), var(--gold), transparent 70%);
    opacity:.35;
  }

  header{text-align:center}
  .brand{font-family:"Oranienbaum",serif;font-size:clamp(32px,5vw,52px);letter-spacing:.06em;color:var(--rose)}

  .toolbar{display:flex;gap:8px;justify-content:center;margin:16px 0 20px}
  button{
    cursor:pointer;border:1px solid var(--gold2);border-radius:10px;padding:10px 14px;
    background:linear-gradient(180deg,#fff8ed,#f0e2c6);color:var(--ink);
    box-shadow:0 1px 0 #fff inset,0 1px 0 rgba(0,0,0,.05);transition:.15s transform ease,.15s box-shadow ease
  }
  button:hover{transform:translateY(-1px);box-shadow:0 2px 0 #fff inset,0 6px 16px rgba(0,0,0,.08)}

  .grid{display:grid;gap:12px;grid-template-columns:0.6fr 1.4fr;align-items:start}

  .card{background:#fffdf7;border:1px solid var(--gold2);border-radius:12px;padding:18px;box-shadow:0 2px 0 #fff inset,0 1px 0 rgba(0,0,0,.05);display:flex;flex-direction:column}
  h2,h3{font-family:"Oranienbaum",serif;margin:0 0 8px}
  h2{font-size:28px} h3{font-size:20px;margin-top:10px}
  .orn{height:14px;margin:8px 0 10px;opacity:.6;background:
      radial-gradient(closest-side,var(--gold) 35%,transparent 36%) 0 50%/10px 10px repeat-x}

  dl.props{margin:0;display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:16px}
  dl.props dt{color:var(--muted)} dl.props dd{margin:0;font-weight:600}

  /* Заголовок "Характеристики" по центру */
  #statsTitle{text-align:center}

  /* Ровные карточки характеристик одного размера */
  .stats{
    display:grid;
    grid-template-columns:repeat(3,1fr);
    gap:10px;
  }
  .stat{
    border:1px solid var(--gold2);
    border-radius:10px;
    padding:10px;
    text-align:center;
    background:linear-gradient(180deg,#fff,#f6ebd3);
    height:90px;                 /* фиксированная одинаковая высота */
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
  }
  .stat b{display:block;font-size:22px;font-family:"Oranienbaum",serif}
  .stat span{font-size:12px;letter-spacing:.08em;color:var(--muted)}

  /* Портрет — прозрачный фон карточки */
  .portrait{
    margin-top:12px;
    border:1px solid var(--gold2);
    border-radius:12px;
    overflow:hidden;
    background:transparent;      /* прозрачный */
    aspect-ratio:3/4;
    display:flex; align-items:center; justify-content:center;
  }
  .portrait img{width:100%;height:100%;object-fit:cover;display:block}
  .portrait .ph{
    font-family:"Oranienbaum",serif;color:var(--soft);opacity:.7;text-align:center;padding:16px;font-size:18px;
  }

  /* Снаряжение */
  ol#gear, ol#trinkets{margin:0;padding-left:1.25em;user-select:none}
  #gear li, #trinkets li{
    display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:10px;
    padding:8px;border:1px dashed rgba(0,0,0,.15);border-radius:10px;margin:6px 0;background:#fff
  }
  /* выравнивание бейджей вправо (и на экране, и при печати) */
  #gear li > div:last-child, #trinkets li > div:last-child{
    justify-self:end; text-align:right; min-width:max-content;
  }
  li.dragging{opacity:.6;border-style:solid}
  .handle{cursor:grab;font-size:18px;line-height:1;color:var(--muted)}
  .delete{cursor:pointer;border:0;background:#0000;color:var(--danger);font-weight:700;font-size:16px}
  .badge{font-size:12px;color:#fff;background:var(--gold2);padding:.15em .5em;border-radius:8px;display:inline-block;min-width:3.2em}

  .overcap{opacity:.55;filter:grayscale(.2)}
  .overcap .badge{background:var(--danger)}
  .muted{color:var(--muted)}
  .subhead{margin-top:12px;font-weight:600;color:var(--soft)}

  /* печать: насыщенные цвета и фиксированное выравнивание */
  @page{ size:A4 portrait; margin:12mm; }
  @media print{
    .toolbar,.handle,.delete{display:none !important}

    html,body{ background:#ffffff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    .sheet{
      width:185mm; max-width:none; box-shadow:none; border-width:6px;
      background:#fffdf8 !important;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }
    .sheet:before,.sheet:after{opacity:.6}

    .grid{ grid-template-columns:0.58fr 1.42fr; gap:8px; }

    #gear li, #trinkets li{ grid-template-columns:auto 1fr auto; }
    #gear li > div:last-child, #trinkets li > div:last-child{ justify-self:end; text-align:right; }
  }
</style>
</head>
<body>
  <div class="sheet">
    <header>
      <div class="brand">П О В О Л Ь Н И К</div>
    </header>

    <div class="toolbar">
      <button id="btnGen">Сотворить повольника</button>
      <button id="btnPrint">Печать</button>
    </div>

    <div class="grid">
      <section class="card">
        <h2 id="name">Имя</h2>
        <div class="orn"></div>
        <dl class="props">
          <dt>Пол:</dt><dd id="gender">—</dd>
          <dt>Прошлое:</dt><dd id="past">—</dd>
          <dt>Выдержка:</dt><dd id="stamina">—</dd>
          <dt>Броня / Защита:</dt><dd id="armor">—</dd>
          <dt>Ячейки для предметов:</dt><dd id="slots">—</dd>
        </dl>
        <h3 id="statsTitle">Характеристики</h3>
        <div class="stats">
          <div class="stat"><b id="SIL">0</b><span>Сила</span></div>
          <div class="stat"><b id="LOV">0</b><span>Ловкость</span></div>
          <div class="stat"><b id="TEL">0</b><span>Телосложение</span></div>
          <div class="stat"><b id="INT">0</b><span>Интеллект</span></div>
          <div class="stat"><b id="MDR">0</b><span>Мудрость</span></div>
          <div class="stat"><b id="HAR">0</b><span>Харизма</span></div>
        </div>

        <!-- Портрет -->
        <div class="portrait" id="portraitBox" aria-label="Портрет персонажа">
          <div class="ph">Портрет будет здесь</div>
        </div>
      </section>

      <section class="card">
        <h3>Снаряжение</h3>
        <ol id="gear"></ol>
        <div class="subhead">Мелкие пожитки</div>
        <ol id="trinkets"></ol>
        <p class="muted" id="carryInfo"></p>
      </section>
    </div>
  </div>

<script>
(function(){
  // === Конфиг портретов ===
  // Имена файлов: M_01..M_NN для мужских, F_01..F_NN для женских.
  const PORTRAIT_PATH = "povolnik_portraits/";   // папка с портретами
  const PORTRAIT_COUNT = 10;                      // число доступных индексов (01..PORTRAIT_COUNT)
  const PORTRAIT_EXTS = ["webp","jpg","jpeg","png", "gif"]; // расширения, перебираются по приоритету
  const INDEX_PAD = 2;                            // длина индекса: 2 -> 01, 02, ...

  // Имена
  const maleNames = ["Первой","Семак","Бажен","Нечай","Добрыня","Ждан","Меньшой","Молчан","Некрас","Тихомир","Богдан","Третьяк","Богомил","Всеволод","Путята","Владимир","Борис","Малюта"];
  const femaleNames = ["Бажена","Вера","Забава","Злата","Малуша","Мирослава","Неждана","Румяна","Надежда","Голуба","Милава","Власта","Купава","Услада","Любовь","Добрава","Малена","Сияна","Чернава","Смирена"];

  // Прошлое и предметы (0 — мелкие пожитки; 1 — ячейка)
  const backgrounds = [
    {title:"Офеня", items:[["Икона",1],["Рулон ткани",1],["Книга",1]]},
    {title:"Ямщик", items:[["Кнут",1],["Ящик с замком",1],["Подорожная грамота",0]]},
    {title:"Зодчий", items:[["Отвес",1],["Коловорот",1],["Пила",1]]},
    {title:"Мясник", items:[["Секач",1],["Крюк",1],["Шмат сала",1]]},
    {title:"Стрелец", items:[["Берендейка",1],["Форменный кафтан",0],["Лядунка",1]]},
    {title:"Иконописец", items:[["Краски",1],["Яйца",0],["Кисти",0]]},
    {title:"Бортник", items:[["Пчелиная шапка",0],["Мёд",1],["Топор",1]]},
    {title:"Алтарник", items:[["Подсвечник",1],["Кадило",1],["Ладан",0]]},
    {title:"Пастух", items:[["Посох",1],["Кнут",1],["Дудка",1]]},
    {title:"Землепашец", items:[["Мотыга",1],["Серп",1],["Паёк",1],["Паёк",1]]},
    {title:"Скоморох", items:[["Гусли",1],["Маска",0],["Ходули",1]]},
    {title:"Пекарь", items:[["Скалка",1],["Мешок муки",1],["Шмат жира",1]]},
    {title:"Цирюльник", items:[["Бритва",0],["Ножницы",0],["Масло",1]]},
    {title:"Кузнец", items:[["Молот",1],["Клещи",1],["Кожаный фартук",0]]},
    {title:"Литейщик", items:[["Черпак",1],["Клещи",1],["Чугунное ядро",1]]},
    {title:"Лесоруб", items:[["Топор",1],["Вязанка дров",1],["Верёвка",1]]},
    {title:"Купец", items:[["Весы",1],["Счёты",1],["Пряности",1]]},
    {title:"Охотник", items:[["Силок",1],["Капкан",1],["Собака",0]]},
    {title:"Священник", items:[["Святая вода",1],["10 свечей",1],["Чётки",0]]},
    {title:"Рыбак", items:[["Сеть",1],["Острога",1],["Верша",1]]}
  ];

  // Оружие
  const melee1h = ["Сабля","Кинжал","Пернач","Клевец","Сулица","Кистень"];
  const melee2h = ["Бердыш","Ослоп","Пальма","Рогатина"];
  const ranged  = ["Праща","Лук"];
  const firearms= ["Пистоль","Пищаль"];
  const allWeapons = [...melee1h, ...melee2h, ...ranged, ...firearms];

  function weaponDamage(n){
    if (melee1h.includes(n)) return "d6";
    if (melee2h.includes(n)) return "d8";
    if (n==="Праща") return "d4";
    if (n==="Лук") return "d6";
    if (firearms.includes(n)) return "2d4";
    return "d6";
  }
  function weaponSlots(n){
    if (melee2h.includes(n) || n==="Лук" || firearms.includes(n)) return 2;
    return 1;
  }

  const ARMOR_CATS = {
    quilt: ["Тегиляй","Поддоспешник"],
    head:  ["Колпак","Шишак","Ерихонка"],
    metal: ["Кольчуга","Куяк","Бехтерец"],
    heavy: ["Зерцало","Кираса"],
    hands: ["Наручи","Закуравье"],
    legs:  ["Бутурлык","Налядвенник"],
    shield:["Щит"]
  };
  const ARMOR_ORDER = ["quilt","head","metal","heavy","hands","legs","shield"];

  // Утилиты
  const $ = s => document.querySelector(s);
  function rollDie(n){ return 1 + Math.floor(Math.random()*n); }
  function choice(a){ return a[Math.floor(Math.random()*a.length)]; }

  function roll3Faces(){
    const map = {1:"SIL",2:"LOV",3:"TEL",4:"INT",5:"MDR",6:"HAR"};
    const s = {SIL:0,LOV:0,TEL:0,INT:0,MDR:0,HAR:0};
    for(let i=0;i<3;i++){ s[map[rollDie(6)]]++; }
    return s;
  }

  // ==== Портреты: подбор по полу (M_01.. / F_01..) ====
  function idxPad(i, pad=INDEX_PAD){
    return String(i).padStart(pad,"0");
  }
  function buildCandidatesByGender(gender){ // gender: "мужской" | "женский"
    const prefix = (gender === "мужской") ? "M_" : "F_";
    const names = [];
    for (let i=1;i<=PORTRAIT_COUNT;i++){
      const base = prefix + idxPad(i);
      for (const ext of PORTRAIT_EXTS){
        names.push(PORTRAIT_PATH + base + "." + ext);
      }
    }
    // небольшая рандомизация очереди
    for (let i=names.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [names[i],names[j]] = [names[j],names[i]];
    }
    return names;
  }
  function tryLoad(src){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve(src);
      img.onerror = ()=>reject(src);
      img.src = src + (src.includes("?")?"&":"?") + "v=" + Math.random().toString(36).slice(2);
    });
  }
  async function loadPortraitForGender(gender){
    const box = $("#portraitBox");
    if (!box) return;

    box.innerHTML = '<div class="ph">Ищем портрет…</div>';
    const pool = buildCandidatesByGender(gender);

    let loadedSrc = null;
    for (const candidate of pool){
      try{ loadedSrc = await tryLoad(candidate); break; }
      catch(_){ /* пробуем следующий */ }
    }

    if (loadedSrc){
      box.innerHTML = "";
      const img = document.createElement("img");
      img.alt = "Портрет персонажа";
      img.src = loadedSrc;
      box.appendChild(img);
    } else {
      box.innerHTML = '<div class="ph">Портрет не найден<br>Добавьте файлы вида <b>M_01</b> / <b>F_01</b> в папку <b>povolnik_portraits</b></div>';
    }
  }

  // ==== Генерация ====
  function generate(){
    const gender = Math.random()<.5 ? "мужской" : "женский";
    const name   = gender==="мужской" ? choice(maleNames) : choice(femaleNames);

    const stats = roll3Faces();
    const stamina = rollDie(6);
    const bg = choice(backgrounds);

    const slotsMax = 10 + (stats.TEL||0);

    const weapon = choice(allWeapons);
    const weaponText = `${weapon} (урон ${weaponDamage(weapon)})`;

    const gear = [];
    const trinkets = [];

    gear.push([weaponText, ((()=> (melee2h.includes(weapon) || weapon==="Лук" || firearms.includes(weapon)) ? 2 : 1))()]);

    for (const [title,slots] of bg.items){
      if (title.includes("Колчан") && weapon !== "Лук") continue;
      if (title.includes("Лядунка") && !firearms.includes(weapon)) continue;
      (slots>0 ? gear : trinkets).push([title,slots]);
    }

    gear.push(["Паёк",1],["Паёк",1],["Факел",1],["Факел",1],["Верёвка, 10 саженей",1]);
    trinkets.push(["Нательный крест",0],[`Монета: ${(rollDie(6)+rollDie(6)+rollDie(6))*10} де́ньг`,0]);

    if (weapon==="Лук") gear.push(["Колчан с 20 стрелами",1]);
    if (firearms.includes(weapon)) gear.push(["Лядунка с 12 пулями и порохом",1]);

    let used = gear.reduce((s,[,c])=>s+c,0);
    const armorPicked = [];
    if (used < slotsMax){
      let i = 0;
      while (used < slotsMax){
        const cat = ARMOR_ORDER[i % ARMOR_ORDER.length];
        const item = choice(ARMOR_CATS[cat]);
        gear.push([`Доспех: ${item}`,1]);
        armorPicked.push(item);
        used++;
        i++;
      }
    }

    const armorValue = armorPicked.length;
    const defense = 11 + armorValue;

    // Вывод свойств
    $("#name").textContent = name;
    $("#gender").textContent = gender;
    $("#past").textContent = bg.title;
    $("#stamina").textContent = String(stamina);
    $("#armor").textContent = `${armorValue} / ${defense}`;
    $("#slots").textContent = `${slotsMax}`;

    // Характеристики
    ["SIL","LOV","TEL","INT","MDR","HAR"].forEach(k=>{
      const el = $("#"+k); if (el) el.textContent = String(stats[k] ?? 0);
    });

    // Списки
    const ol = $("#gear"); ol.innerHTML = "";
    gear.forEach(([t,s]) => addItem(ol, t, s));

    const tr = $("#trinkets"); tr.innerHTML = "";
    trinkets.forEach(([t,s]) => addItem(tr, t, s));

    updateCarry(ol, slotsMax);

    // Портрет по полу
    loadPortraitForGender(gender);
  }

  // Элементы списков (Drag&Drop + удаление)
  function addItem(list, text, slots=0){
    const li = document.createElement("li");
    li.draggable = true;
    li.dataset.slots = String(slots);

    const handle = document.createElement("span");
    handle.className = "handle";
    handle.title = "Потянуть, чтобы переставить";
    handle.textContent = "↕";

    const label = document.createElement("div");
    label.textContent = text;

    const right = document.createElement("div");
    const badge = document.createElement("span");
    badge.className = "badge";
    badge.title = "Сколько ячеек занимает";
    badge.textContent = `${slots} яч.`;
    right.appendChild(badge);

    const del = document.createElement("button");
    del.className = "delete";
    del.title = "Удалить";
    del.textContent = "✕";
    del.addEventListener("click", ()=>{
      li.remove();
      updateCarry($("#gear"), +$("#slots").textContent);
    });
    right.appendChild(del);

    li.append(handle,label,right);

    // DnD
    li.addEventListener("dragstart", e=>{
      li.classList.add("dragging");
      e.dataTransfer.setData("text/plain","drag");
    });
    li.addEventListener("dragend", ()=>{
      li.classList.remove("dragging");
      updateCarry($("#gear"), +$("#slots").textContent);
    });

    list.appendChild(li);

    if (!list._dndBound){
      list.addEventListener("dragover", e=>{
        e.preventDefault();
        const dragging = list.querySelector(".dragging");
        if (!dragging) return;
        const after = getAfter(list, e.clientY);
        if (after==null) list.appendChild(dragging);
        else list.insertBefore(dragging, after);
      });
      list._dndBound = true;
    }
  }

  function getAfter(container, y){
    const els = [...container.querySelectorAll("li:not(.dragging)")];
    return els.reduce((closest, child)=>{
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height/2;
      if (offset < 0 && offset > closest.offset){
        return {offset, element: child};
      } else { return closest; }
    }, {offset: Number.NEGATIVE_INFINITY}).element;
  }

  function updateCarry(ol, slotsMax){
    let used = 0;
    [...ol.children].forEach(li=>{
      const c = +li.dataset.slots || 0;
      used += c;
      if (used > slotsMax){ li.classList.add("overcap"); li.title = "Недоступно: не хватает ячеек"; }
      else { li.classList.remove("overcap"); li.title = ""; }
    });
    $("#carryInfo").textContent = `Занято: ${Math.min(used,slotsMax)} / ${slotsMax}` + (used>slotsMax ? " (есть недоступные предметы выше лимита)":"");
  }

  // Кнопки и старт
  $("#btnGen").addEventListener("click", generate);
  $("#btnPrint").addEventListener("click", ()=>window.print());
  window.addEventListener("DOMContentLoaded", generate);
})();
</script>
</body>
</html>
